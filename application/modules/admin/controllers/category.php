<?phpclass category extends MY_Controller{    public function __construct(){        parent::__construct();        $this->_data['now'] = 'Danh Mục ';        $this->load->model('mcategory');        $this->load->model('mproduct');        $user = $this->session->userdata('user');        if(!$user || $user['user_type'] != 'administrator'){            if($user['user_type']!='nhanvien' || !strpos($_SERVER['REQUEST_URI'],'admin/product/phieubanhang')){                redirect(base_url()."admin/product/phieubanhang");                }                        }        $this->form_validation->CI =& $this;        $this->_data['listcate'] = $this->mcategory->getMenu();        //--------        //Lấy đường dẫn url của thư mục chứa hình ảnh được upload        $this->_gallery_url = base_url()."public/danhmuc/";        //Lấy đường dẫn vật lý của thư mục chứa hình ảnh đươc upload        $this->_gallery_path = realpath(APPPATH. "../public/danhmuc");    }    public function listall(){        if(!isset($_GET['per_page'])){            $start = 0 ;        }else{            $start=$_GET['per_page'];        }        $this->_data['template'] = 'admin/category/list_view';        $this->_data['info'] = $this->mcategory->getMenu();        $this->load->view("layout/admin",$this->_data);    }    function del($id){        $list = $this->mcategory->getfamily($id);        foreach($list as $id){            $product = $this->mproduct->getCategory2($id,99999,0);            if(count($product)!=0){                foreach($product as $p){                    $arr = array(                        'category_id'=>163                    );                    $this->mproduct->editById($p['id'],$arr);                }               }            $this->mcategory->delete($id);        }        $this->session->set_flashdata('ses_flash',"Xóa");        redirect(base_url().'admin/category/listall');    }    public function add(){        $this->_data['action'] = strtolower(__FUNCTION__);        if(isset($_POST['ok'])){            $this->form_validation->set_rules("name","Tên","required");            $this->form_validation->set_rules("link","Link","callback_check_link");            if($this->form_validation->run()==TRUE){                  //----------------                $config = array('upload_path'   => $this->_gallery_path,                    'allowed_types' => 'gif|jpg|png',                    'max_size'      => '2000');                $this->load->library("upload",$config);                if(!$this->upload->do_upload("image")){                    $data['file_name'] = 'error';                }else{                    $data =$this->upload->data();                }                if(!$this->upload->do_upload("image2")){                    $data2['file_name'] = 'error';                }else{                    $data2 =$this->upload->data();                }                $arr = array(                    'name' => $this->input->post('name'),                    'link' => $this->input->post('link2'),                    'hinhanh' =>$data['file_name'],                    'hinhanh2' =>$data2['file_name'],                    'order' => $this->input->post('order'),                    'parent_id' => $this->input->post('parent_id'),                    'created' => time(),                );                $this->mcategory->add($arr);                $this->session->set_flashdata('ses_flash',"Thêm");                redirect(base_url()."admin/category/listall");            }        }        $this->_data['template'] = 'admin/category/modify_view';        $this->_data['title'] = 'Thêm';        $this->load->view("layout/admin",$this->_data);    }    public function check_link($link){        if($this->mcategory->checkLink($link)==false){            $this->form_validation->set_message("check_link","Tên danh mục đã được sử dụng .");            return false;        }else{            return true;        }    }    public function edit($id){        $this->_data['action'] = strtolower(__FUNCTION__);        if(isset($_POST['ok'])){            $this->form_validation->set_rules("name","Tên","required");            if($this->form_validation->run()==TRUE){                      if($_FILES['image']['name']=="" && $_FILES['image2']['name']==""){                    $arr = array(                        'name' => $this->input->post('name'),                        'link' => $this->input->post('link2'),                        'order' => $this->input->post('order'),                        'parent_id' => $this->input->post('parent_id'),                        'created' => time(),                    );                    $this->mcategory->editById($id,$arr);                    $this->session->set_flashdata('ses_flash',"Sửa");                    redirect(base_url()."admin/category/listall");                } else if($_FILES['image']['name']!="" && $_FILES['image2']['name']==""){                    $config = array('upload_path'   => $this->_gallery_path,                        'allowed_types' => 'gif|jpg|png',                        'max_size'      => '2000');                    $this->load->library("upload",$config);                    if(!$this->upload->do_upload("image")){                        $data['file_name'] = 'error';                    }else{                        $data =$this->upload->data();                    }                    $arr = array(                        'name' => $this->input->post('name'),                        'link' => $this->input->post('link2'),                        'hinhanh' =>$data['file_name'],                        'order' => $this->input->post('order'),                        'parent_id' => $this->input->post('parent_id'),                        'created' => time(),                    );                    $this->mcategory->editById($id,$arr);                    $this->session->set_flashdata('ses_flash',"Sửa");                    redirect(base_url()."admin/category/listall");                } else if($_FILES['image']['name']=="" && $_FILES['image2']['name']!=""){                    $config = array('upload_path'   => $this->_gallery_path,                        'allowed_types' => 'gif|jpg|png',                        'max_size'      => '2000');                    $this->load->library("upload",$config);                    if(!$this->upload->do_upload("image2")){                        $data2['file_name'] = 'error';                    }else{                        $data2 =$this->upload->data();                    }                    $arr = array(                        'name' => $this->input->post('name'),                        'link' => $this->input->post('link2'),                        'hinhanh2' =>$data2['file_name'],                        'order' => $this->input->post('order'),                        'parent_id' => $this->input->post('parent_id'),                        'created' => time(),                    );                    $this->mcategory->editById($id,$arr);                    $this->session->set_flashdata('ses_flash',"Sửa");                    redirect(base_url()."admin/category/listall");                }else{                    //----------------                    $config = array('upload_path'   => $this->_gallery_path,                        'allowed_types' => 'gif|jpg|png',                        'max_size'      => '2000');                    $this->load->library("upload",$config);                    if(!$this->upload->do_upload("image")){                        $data['file_name'] = 'error';                    }else{                        $data =$this->upload->data();                    }                    if(!$this->upload->do_upload("image2")){                        $data2['file_name'] = 'error';                    }else{                        $data2 =$this->upload->data();                    }                    $arr = array(                        'name' => $this->input->post('name'),                        'link' => $this->input->post('link2'),                        'hinhanh' =>$data['file_name'],                        'hinhanh2' =>$data2['file_name'],                        'order' => $this->input->post('order'),                        'parent_id' => $this->input->post('parent_id'),                        'created' => time(),                    );                    $this->mcategory->editById($id,$arr);                    $this->session->set_flashdata('ses_flash',"Sửa");                    redirect(base_url()."admin/category/listall");                }            }        }        $this->_data['info'] = $this->mcategory->getById($id);        $this->_data['template'] = 'admin/category/modify_view';        $this->_data['title'] = 'Trang Sửa User ';        $this->load->view("layout/admin",$this->_data);    }    function live_generateSlug(){        $slug = $this->generateSlug($this->input->post('title'));        echo $slug;    }    function generateSlug($name){        $slug = url_title(trim($name), 'dash', true);        $suffix = 0;        while($this->mcategory->getbyslug($slug)){            if ($suffix)                $slug = preg_replace ('/[0-9]+$/', ++$suffix, $slug );            else                $slug .= '-' . ++$suffix;        }        return $slug;    }    public function sort(){        $id   = $_POST['id'];        $arr = array(            'order' => $this->input->post('value'),        );        $this->mcategory->editById($id,$arr);    }    function image_check(){        if ($_FILES['avatar']['name']!='') return true;        $this->form_validation->set_message('image_check', 'Vui lòng tải Ảnh Banner');        return FALSE;    }    function image_mini_check(){        if ($_FILES['mini_avatar']['name']!='') return true;        $this->form_validation->set_message('image_mini_check', 'Vui lòng tải Ảnh Đại Diện');        return FALSE;    }}