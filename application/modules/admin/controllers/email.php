<?phpclass email extends MY_Controller{    public function __construct(){        parent::__construct();        $this->_data['now'] = 'Email';        $user = $this->session->userdata('user');        if(!$user || $user['user_type'] != 'administrator'){            if($user['user_type']!='nhanvien' || !strpos($_SERVER['REQUEST_URI'],'admin/product/phieubanhang')){                redirect(base_url()."admin/product/phieubanhang");                }                        }        $this->form_validation->CI =& $this;        $this->load->model('mconfig');        $this->load->model('memail');        $this->load->model('mproduct');    }    public function listall(){        if(!isset($_GET['per_page'])){            $start = 0 ;        }else{            $start=$_GET['per_page'];        }        $this->load->library('pagination');        $config['base_url'] = base_url().'admin/email/listall?';        //config phân trang        $config['total_rows'] = $this->memail->numRows();        $config['per_page'] =15;        $config['uri_segment'] = 4;        $config['cur_tag_open'] = "<li><a><font color='black'>";        $config['cur_tag_close'] = '</font></a></li>';        $config['num_tag_open'] = '<li>';        $config['num_tag_close'] = '</li>';        $config['prev_link'] = 'Prev';        $config['prev_tag_open'] = '<li>';        $config['prev_tag_close'] = '</li>';        $config['next_link'] = 'Next';        $config['next_tag_open'] = '<li>';        $config['next_tag_close'] = '</li>';        $config['first_tag_open'] = '<li>';        $config['first_tag_close'] = '</li>';        $config['last_tag_open'] = '<li>';        $config['last_tag_close'] = '</li>';        $this->pagination->initialize($config);        $this->_data['pagination']=$this->pagination->create_links();        $this->_data['template'] = 'admin/email/list_view';        $this->_data['title'] = 'Trang Quản Lý Danh Mục ';        $this->_data['info'] = $this->memail->listAll($config['per_page'],$start);        $this->load->view("layout/admin",$this->_data);    }    public function  log(){        //-------------------        //Lấy đường dẫn vật lý        $path = realpath(APPPATH. "../public/log_email.txt");        $handle = fopen($path, "r");        $data = array();        while (!feof($handle)) {                $data[] = fgets($handle);        }        fclose($handle);        $this->_data['data'] = array_reverse($data);        //-------------------        $this->_data['template'] = 'admin/email/log';        $this->load->view("layout/admin",$this->_data);    }    public function add(){        $this->_data['action'] = strtolower(__FUNCTION__);        if(isset($_POST['ok'])){            $this->form_validation->set_rules("name","Tên","required");            if($this->form_validation->run()==TRUE){                $csv = $_FILES['csv'];                $this->load->library('csvimport');                $data = $this->csvimport->get_array($csv['tmp_name']);                $sendto = array();                foreach($data as $value){                    $c = true ;                    foreach($sendto as $check){                        if($check == $value['email']){                            $c= false ;                        }                    }                    if($c){                        $sendto[] = $value['email'];                    }                }                $arr = array(                    'name' => $this->input->post('name'),                    'list' => json_encode($sendto),                    'created' => time(),                );                $this->memail->add($arr);                $this->session->set_flashdata('ses_flash',"Thêm");                redirect(base_url()."admin/email/listall");            }        }        $this->_data['template'] = 'admin/email/modify_view';        $this->_data['title'] = 'Thêm';        $this->load->view("layout/admin",$this->_data);    }    public function del($id){        $this->memail->del($id);        $this->session->set_flashdata('ses_flash',"Xóa");        redirect(base_url()."admin/email/listall");    }    public function show($id){        $info = $this->memail->getById($id);        $this->_data['info'] = $info ;        if(isset($_POST['ok'])){            $arr = array(                'list' => json_encode($_POST['email'])            );            $this->memail->editById($id,$arr);            redirect(base_url()."admin/email/listall");        }        $this->_data['template'] = 'admin/email/show';        $this->load->view("layout/admin",$this->_data);    }    function product_check(){        if(isset($_POST['product'])){            if (count($_POST['product'])!=0 && count($_POST['product'])%3==0) return true;        }        $this->form_validation->set_message('product_check', 'Số Lượng sản phẩm phải là bội số của 3');        return FALSE;    }    public function send($id){        ignore_user_abort(1); // run script in background        set_time_limit(0); // run script forever        $info = $this->memail->getById($id);        $sendto = json_decode($info['list']);        if(isset($_POST['ok'])){            $this->form_validation->set_rules("title","Tiêu Đề","required");            $this->form_validation->set_rules("header","Header","required");            $this->form_validation->set_rules("product","Sản Phẩm","callback_product_check");            $this->form_validation->set_rules("footer","Footer","required");            if($this->form_validation->run()==TRUE){                // send mail                $config = array(                    'protocol' => $this->mconfig->getByKey('protocol'),                    'smtp_host' => $this->mconfig->getByKey('smtp_host'),                    'smtp_port' => $this->mconfig->getByKey('smtp_port'),                    'smtp_user' => $this->mconfig->getByKey('smtp_user'),                    'smtp_pass' => $this->mconfig->getByKey('smtp_pass'),                );                $from = $this->mconfig->getByKey('mail_from');                $sub= $_POST['title'];                $param = array(                    'list'=>$_POST['product'],                    'header'=>$_POST['header'],                    'footer'=>$_POST['footer'],                );                $mess= $this->load->view('admin/email/template',$param,TRUE);                $file = 'mail/mail.html';                $out = strtr($mess,Array("<"=>"&lt;","&"=>"&amp;"));                if($_POST['code']=='ok'){                    $this->_data['code'] = $out;                    $this->_data['template'] = 'admin/email/viewcode';                    $this->load->view("layout/admin",$this->_data);                    return;                }                else{                    $stt = 0 ;                    $this->mconfig->update(count($sendto),'total_email');                    foreach($sendto as $val){                        $stt ++ ;                        $this->mconfig->update($stt,'curent_email');                        $to = $val;                        $this->sendmail($config,$from,$to,$sub,$mess);                    }                    $this->mconfig->update('false','curent_email');                    //-------------------                    //Lấy đường dẫn vật lý                    $path = realpath(APPPATH. "../public/log_email.txt");                    $handle = fopen($path, "a");                    fwrite($handle, "\r\n");                    fwrite($handle, 'Đã gửi danh sách <b>"'.$info['name'].'"</b> vào lúc <b>'.date("H:i:s d-m-Y").'</b> với tiêu đề <b>"'.$_POST['title'].'"</b>');                    fclose($handle);                    //-------------------                    redirect(base_url()."admin/email/listall");                   }            }        }        $this->_data['id'] = $id;        $this->_data['product'] = $this->mproduct->getAll();        $this->_data['template'] = 'admin/email/send';        $this->load->view("layout/admin",$this->_data);    }}